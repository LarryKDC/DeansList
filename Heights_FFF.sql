DECLARE @REPORTDATE DATE;
SET @REPORTDATE = '${ReportDate}';
SELECT 
S.STUDENT_NUMBER,
@REPORTDATE AS REPORTDATE,
CW.CHANGE AS STMATH_MASTERY_CURRENT,
YTD.STMATH_MASTERY AS STMATH_MASTERY_YTD,
I.TIME_ON_TASK
FROM POWERSCHOOL.POWERSCHOOL_STUDENTS S
LEFT JOIN (
		SELECT
		STUDENT_NUMBER,
		CAST(REPORTDATE AS DATE) REPORTDATE,
		K_5_MASTERY AS STMATH_MASTERY
		FROM POWERSCHOOL.POWERSCHOOL_STUDENTS S 
		JOIN [custom].[Instruction_STMath_LJ] ST ON ST.SCHOOL_STUDENT_ID = S.STUDENT_NUMBER
		WHERE S.SCHOOLID = 1007 --ONLY PULL HEIGHTS STUDENTS
		AND REPORTDATE >= '2016-08-08' --RECORDS FOR THE 16-17 SCHOOL YEAR START ON 8/8/16
	) YTD ON YTD.STUDENT_NUMBER = S.STUDENT_NUMBER AND REPORTDATE = @REPORTDATE
LEFT JOIN (
		SELECT
		S.STUDENT_NUMBER,
		CHANGE,
		REPORTDATE
		FROM (
			SELECT
			CAST(K_5_MASTERY AS FLOAT) - CAST(LAG(K_5_MASTERY,1,0) OVER (PARTITION BY SCHOOL_STUDENT_ID ORDER BY SCHOOL_STUDENT_ID,REPORTDATE) AS FLOAT) AS CHANGE,
			LAG(K_5_MASTERY,1,0) OVER (ORDER BY SCHOOL_STUDENT_ID,REPORTDATE) AS LAST_WEEK,
			ST.*
			FROM [custom].[Instruction_STMath_LJ] ST
			WHERE INSTITUTION_NAME = 'KIPP DC Heights Academy'
			AND REPORTDATE >= DATEADD(DAY,-7,(SELECT MAX(REPORTDATE) FROM [custom].[Instruction_STMath_LJ]))
			--AND SCHOOL_STUDENT_ID = 10037
			--ORDER BY SCHOOL_STUDENT_ID,REPORTDATE
		) ST
		JOIN POWERSCHOOL.POWERSCHOOL_STUDENTS S ON ST.SCHOOL_STUDENT_ID = S.STUDENT_NUMBER
		WHERE ST.REPORTDATE = (SELECT MAX(REPORTDATE) FROM [custom].[Instruction_STMath_LJ])
	) CW ON CW.STUDENT_NUMBER = S.STUDENT_NUMBER AND CW.REPORTDATE = @REPORTDATE
LEFT JOIN (
		SELECT
		[STUDENTID],
		school,
		CASE -- THIS ASSIGNS THE DATE OF THE FRIDAY OF THE WEEK THAT THE LESSON WAS PASSED SO THEY CAN BY GROUPED BY WEEK
			WHEN DATEPART(DW,CAST(I.[COMPLETIONDATE] AS DATE))<=6 THEN DATEADD(D,6-DATEPART(DW,CAST(I.[COMPLETIONDATE] AS DATE)),CAST(I.[COMPLETIONDATE] AS DATE))
			WHEN DATEPART(DW,CAST(I.[COMPLETIONDATE] AS DATE))=7 THEN DATEADD(D,6 ,CAST(I.[COMPLETIONDATE] AS DATE))
			ELSE NULL
		END TESTDATE,
		SUM(CAST([TIMEONTASKMINUTES] AS INT)) TIME_ON_TASK
		FROM
		[CUST1220].[TEST_IREADY].[Test_iReady_RawData_LessonActivity_ELA] I
		WHERE LASTNAME != 'Last Name' --remove first record with headers
		GROUP BY (CASE -- THIS ASSIGNS THE DATE OF THE FRIDAY OF THE WEEK THAT THE LESSON WAS PASSED SO THEY CAN BY GROUPED BY WEEK
					WHEN DATEPART(DW,CAST(I.[COMPLETIONDATE] AS DATE))<=6 THEN DATEADD(D,6-DATEPART(DW,CAST(I.[COMPLETIONDATE] AS DATE)),CAST(I.[COMPLETIONDATE] AS DATE))
					WHEN DATEPART(DW,CAST(I.[COMPLETIONDATE] AS DATE))=7 THEN DATEADD(D,6 ,CAST(I.[COMPLETIONDATE] AS DATE))
					ELSE NULL
				  END),[STUDENTID],SCHOOL) I ON cast(I.[STUDENTID] as int) = S.STUDENT_NUMBER AND CONVERT(VARCHAR,I.TESTDATE,121) = @REPORTDATE
WHERE S.SCHOOLID = 1007
AND S.ENROLL_STATUS = 0
and S.HOME_ROOM NOT LIKE 'LC%'
